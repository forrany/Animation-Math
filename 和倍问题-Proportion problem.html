<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>和倍问题探险</title>
    <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-100-M/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-300 */
        }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .ui-panel {
            position: absolute;
            background-color: rgba(26, 32, 44, 0.85); /* Tailwind gray-900 with opacity */
            border: 1px solid #4a5568; /* Tailwind gray-600 */
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .input-field {
            background-color: #2d3748; /* Tailwind gray-800 */
            color: #e2e8f0; /* Tailwind gray-300 */
            border: 1px solid #4a5568; /* Tailwind gray-600 */
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            width: 100px;
            text-align: center;
        }
        .input-field:focus {
            outline: none;
            border-color: #63b3ed; /* Tailwind blue-400 */
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            min-width: 120px; /* Ensure buttons are large enough */
            min-height: 50px;
        }
        .btn-primary {
            background-color: #4299e1; /* Tailwind blue-500 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #3182ce; /* Tailwind blue-600 */
        }
        .btn-secondary {
            background-color: #4a5568; /* Tailwind gray-600 */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #2d3748; /* Tailwind gray-800 */
        }
        .feedback-correct { color: #48bb78; /* Tailwind green-500 */ }
        .feedback-incorrect { color: #f56565; /* Tailwind red-500 */ }
        .achievement-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #48bb78; /* Tailwind green-500 */
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            font-size: 1.25rem;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #2d3748; /* gray-800 */
            border-radius: 0.25rem;
            height: 20px;
            margin-top: 0.5rem;
        }
        .progress-bar {
            background-color: #4299e1; /* blue-500 */
            height: 100%;
            border-radius: 0.25rem;
            transition: width 0.5s ease-in-out;
            text-align: center;
            line-height: 20px;
            font-size: 0.75rem;
            color: white;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out; /* Base transition for opacity */
        }
        .modal-content {
            min-width: 300px;
            max-width: 90%;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .guide-orb {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #a7f3d0, #34d399); /* Tailwind green-200 to green-500 */
            border-radius: 50%;
            box-shadow: 0 0 15px #34d399, 0 0 30px #34d399;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #065f46; /* Tailwind green-800 */
            z-index: 1; /* Below UI panels */
        }
        .collectible-fragment {
            position: absolute;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #fde68a, #f59e0b); /* Tailwind amber-200 to amber-500 */
            border-radius: 50%;
            box-shadow: 0 0 10px #f59e0b;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            z-index: 1;
        }
        .collectible-fragment:hover {
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="three-canvas"></canvas>

        <!-- Top UI: Title, Progress -->
        <div class="ui-panel top-4 left-4">
            <h1 class="text-2xl font-serif-sc font-bold">和倍问题探险</h1>
            <div class="mt-2">
                <span>经验值 (XP): <span id="xp-value">0</span></span>
                <div class="progress-bar-container">
                    <div id="xp-bar" class="progress-bar" style="width: 0%;">0%</div>
                </div>
            </div>
            <div class="mt-1">
                <span>当前关卡: <span id="level-value">1</span></span>
            </div>
        </div>

        <!-- Problem & Interaction Panel -->
        <div id="problem-panel" class="ui-panel bottom-4 left-1/2 transform -translate-x-1/2 w-11/12 md:w-1/2 lg:w-1/3">
            <h2 id="problem-title" class="text-xl font-serif-sc font-semibold mb-2">任务目标</h2>
            <p id="problem-story" class="mb-4"></p>
            
            <div id="step-1-inputs" class="space-y-3">
                <p>观察场景中的水晶堆。乙水晶堆代表1份，甲水晶堆是乙的几倍？</p>
                <p>乙水晶堆有 <span class="font-bold text-xl text-blue-400">1</span> 份能量。</p>
                <p>甲水晶堆是乙的 <span id="multiple-display" class="font-bold text-xl text-yellow-400">?</span> 倍，所以甲水晶堆有 <span id="larger-parts-display" class="font-bold text-xl text-yellow-400">?</span> 份能量。</p>
                <p>甲乙两堆水晶共有几份能量？</p>
                <input type="number" id="total-parts-input" class="input-field" placeholder="总份数">
                <button id="submit-total-parts" class="btn btn-primary">确认总份数</button>
            </div>

            <div id="step-2-inputs" class="space-y-3 hidden">
                <p>已知总能量为 <span id="total-sum-display" class="font-bold text-xl text-green-400">?</span>，总份数为 <span id="confirmed-total-parts" class="font-bold text-xl text-green-400">?</span>。</p>
                <p>那么，1份能量代表多少？</p>
                <input type="number" id="one-part-value-input" class="input-field" placeholder="1份的量">
                <button id="submit-one-part-value" class="btn btn-primary">确认每份能量</button>
            </div>

            <div id="step-3-inputs" class="space-y-3 hidden">
                <p>太棒了！1份能量是 <span id="confirmed-one-part-value" class="font-bold text-xl text-green-400">?</span>。</p>
                <p>乙水晶堆 (1份) 的能量是多少？</p>
                <input type="number" id="smaller-value-input" class="input-field" placeholder="乙的能量">
                <button id="submit-smaller-value" class="btn btn-primary">确认乙能量</button>
            </div>
            
            <div id="step-4-inputs" class="space-y-3 hidden">
                 <p>乙水晶堆能量为 <span id="confirmed-smaller-value" class="font-bold text-xl text-green-400">?</span>。</p>
                <p>甲水晶堆 (<span id="larger-parts-final-display" class="font-bold text-xl text-yellow-400">?</span> 份) 的能量是多少？</p>
                <input type="number" id="larger-value-input" class="input-field" placeholder="甲的能量">
                <button id="submit-larger-value" class="btn btn-primary">确认甲能量</button>
            </div>

            <p id="feedback-text" class="mt-3 font-semibold h-6"></p>
        </div>
        
        <!-- Guide Orb -->
        <div id="guide-orb" class="guide-orb">
            <i class="fas fa-lightbulb"></i>
        </div>
        
        <!-- Knowledge Fragments -->
        <div id="knowledge-fragments-container">
            <!-- Fragments will be added here by JS -->
        </div>

        <!-- Achievement Toast -->
        <div id="achievement-toast" class="achievement-toast">
            <i class="fas fa-trophy mr-2"></i> <span id="achievement-text">成就解锁！</span>
        </div>
        
        <!-- Modal for Intro/Help -->
        <div id="intro-modal" class="modal active">
            <div class="ui-panel modal-content text-center">
                <h2 class="text-2xl font-serif-sc font-bold mb-4">欢迎来到和倍问题探险！</h2>
                <p class="mb-4">你将化身水晶探险家，通过解决和倍问题来收集能量水晶。观察场景，按照提示完成任务吧！</p>
                <p class="mb-2 text-sm text-gray-400">提示：和倍问题的核心是找出 "1份" 是多少。</p>
                <p class="mb-6 text-sm text-gray-400">甲 + 乙 = 和</p>
                <p class="mb-6 text-sm text-gray-400">甲 = 乙 × 倍数</p>
                <button id="start-game-btn" class="btn btn-primary">开始探险</button>
            </div>
        </div>
        
        <!-- Modal for Level Complete -->
        <div id="level-complete-modal" class="modal">
            <div class="ui-panel modal-content text-center">
                <h2 id="level-complete-title" class="text-2xl font-serif-sc font-bold mb-4">太棒了！</h2>
                <p id="level-complete-message" class="mb-4">你成功解决了这个问题！</p>
                <div id="level-summary" class="mb-4"></div>
                <button id="next-level-btn" class="btn btn-primary">下一关</button>
            </div>
        </div>

    </div>

    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/three.js/110/three.min.js"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/gsap/3.9.1/gsap.min.js"></script>
    <script>
        let scene, camera, renderer;
        let smallerCrystalGroup, largerCrystalGroup;
        let guideOrbElement;
        let currentProblem, problems, currentProblemIndex = 0;
        let xp = 0, level = 1;
        const xpPerCorrectStep = 10;
        const xpToNextLevel = 100;
        let achievements = {};

        // UI Elements
        const xpValueElement = document.getElementById('xp-value');
        const xpBarElement = document.getElementById('xp-bar');
        const levelValueElement = document.getElementById('level-value');
        const problemStoryElement = document.getElementById('problem-story');
        const multipleDisplayElement = document.getElementById('multiple-display');
        const largerPartsDisplayElement = document.getElementById('larger-parts-display');
        const totalPartsInputElement = document.getElementById('total-parts-input');
        const submitTotalPartsButton = document.getElementById('submit-total-parts');
        
        const totalSumDisplayElement = document.getElementById('total-sum-display');
        const confirmedTotalPartsElement = document.getElementById('confirmed-total-parts');
        const onePartValueInputElement = document.getElementById('one-part-value-input');
        const submitOnePartValueButton = document.getElementById('submit-one-part-value');

        const confirmedOnePartValueElement = document.getElementById('confirmed-one-part-value');
        const smallerValueInputElement = document.getElementById('smaller-value-input');
        const submitSmallerValueButton = document.getElementById('submit-smaller-value');
        
        const confirmedSmallerValueElement = document.getElementById('confirmed-smaller-value');
        const largerPartsFinalDisplayElement = document.getElementById('larger-parts-final-display');
        const largerValueInputElement = document.getElementById('larger-value-input');
        const submitLargerValueButton = document.getElementById('submit-larger-value');

        const feedbackTextElement = document.getElementById('feedback-text');
        const introModal = document.getElementById('intro-modal');
        const startGameBtn = document.getElementById('start-game-btn');
        const levelCompleteModal = document.getElementById('level-complete-modal');
        const levelCompleteTitle = document.getElementById('level-complete-title');
        const levelCompleteMessage = document.getElementById('level-complete-message');
        const levelSummaryElement = document.getElementById('level-summary');
        const nextLevelBtn = document.getElementById('next-level-btn');
        
        const stepPanels = [
            document.getElementById('step-1-inputs'),
            document.getElementById('step-2-inputs'),
            document.getElementById('step-3-inputs'),
            document.getElementById('step-4-inputs'),
        ];
        let currentStep = 0;

        // Game Data
        problems = [
            { sum: 30, multiple: 2, smallerName: "乙", largerName: "甲", story: "甲乙两堆能量水晶，共储存30单位能量。甲水晶堆的能量是乙水晶堆的2倍。请找出甲乙两堆水晶各有多少单位能量。", solution: { totalParts: 3, onePartValue: 10, smallerValue: 10, largerValue: 20 } },
            { sum: 48, multiple: 3, smallerName: "蓝", largerName: "红", story: "红蓝两种宝石，总价值48魔石。红宝石的价值是蓝宝石的3倍。它们各自价值多少魔石？", solution: { totalParts: 4, onePartValue: 12, smallerValue: 12, largerValue: 36 } },
            { sum: 75, multiple: 4, smallerName: "小", largerName: "大", story: "大小两个宝箱，共藏有75枚金币。大宝箱的金币数量是小宝箱的4倍。两个宝箱各有多少金币？", solution: { totalParts: 5, onePartValue: 15, smallerValue: 15, largerValue: 60 } },
            { sum: 120, multiple: 5, smallerName: "暗影", largerName: "光明", story: "光明与暗影两种法力水晶，总能量为120点。光明水晶的能量是暗影水晶的5倍。求两种水晶各自的能量值。", solution: { totalParts: 6, onePartValue: 20, smallerValue: 20, largerValue: 100 } }
        ];

        function initThree() {
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a202c, 10, 30);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas'), antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // Transparent background

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshStandardMaterial({ color: 0x2d3748, roughness: 0.8 }); // Tailwind gray-800
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Crystal groups
            smallerCrystalGroup = new THREE.Group();
            largerCrystalGroup = new THREE.Group();
            scene.add(smallerCrystalGroup);
            scene.add(largerCrystalGroup);
            
            guideOrbElement = document.getElementById('guide-orb');

            animate();
            loadProgress(); // Load progress before first loadProblem
            loadProblem();
            setupEventListeners();
            updateUI(); // Initial UI update based on loaded/default state
        }

        function createCrystal(color, size = 0.5) {
            const geometry = new THREE.BoxGeometry(size, size * 1.5, size); 
            const material = new THREE.MeshStandardMaterial({ 
                color: color, 
                roughness: 0.3, 
                metalness: 0.2,
                transparent: true,
                opacity: 0.9
            });
            const crystal = new THREE.Mesh(geometry, material);
            crystal.castShadow = true;
            return crystal;
        }

        function displayCrystals(problem) {
            while(smallerCrystalGroup.children.length > 0) smallerCrystalGroup.remove(smallerCrystalGroup.children[0]);
            while(largerCrystalGroup.children.length > 0) largerCrystalGroup.remove(largerCrystalGroup.children[0]);

            const crystalSize = 0.6;
            const smallerCrystal = createCrystal(0x63b3ed, crystalSize);
            smallerCrystal.position.set(0, crystalSize * 1.5 / 2, 0);
            smallerCrystalGroup.add(smallerCrystal);
            smallerCrystalGroup.position.set(-2.5, 0, 0);

            for (let i = 0; i < problem.multiple; i++) {
                const largerCrystal = createCrystal(0xf6e05e, crystalSize);
                largerCrystal.position.set(0, (crystalSize * 1.5 / 2) + i * (crystalSize * 1.5 + 0.1), 0);
                largerCrystalGroup.add(largerCrystal);
            }
            largerCrystalGroup.position.set(2.5, 0, 0);

            gsap.from([...smallerCrystalGroup.children, ...largerCrystalGroup.children].map(c => c.scale), {
                x:0.01, y:0.01, z:0.01, duration: 0.8, stagger: 0.1, ease: "back.out(1.7)"
            });
            gsap.from([...smallerCrystalGroup.children, ...largerCrystalGroup.children].map(c => c.rotation), {
                y: Math.PI, duration: 0.8, stagger: 0.1, ease: "power2.out"
            });
        }
        
        function animateGuideOrbToElement(element) {
            if (!element) return;
            const rect = element.getBoundingClientRect();
            const targetX = rect.left + rect.width / 2 - guideOrbElement.offsetWidth / 2;
            let targetY = rect.top - guideOrbElement.offsetHeight - 10; 
            if (targetY < 10) {
                targetY = rect.bottom + 10;
            }
            if (targetY + guideOrbElement.offsetHeight > window.innerHeight -10) {
                 targetY = rect.top + rect.height / 2 - guideOrbElement.offsetHeight / 2;
            }

            gsap.to(guideOrbElement, {
                x: targetX,
                y: targetY,
                duration: 0.7,
                ease: "power2.inOut"
            });
        }

        function loadProblem() {
            if (currentProblemIndex >= problems.length) {
                levelCompleteTitle.textContent = "恭喜通关！";
                levelCompleteMessage.textContent = "你已经掌握了所有和倍问题的挑战！";
                levelSummaryElement.innerHTML = `<p>总经验: ${xp}</p><p>你真是个和倍问题大师！</p><i class="fas fa-crown text-yellow-400 text-4xl my-2"></i>`;
                nextLevelBtn.textContent = "重新开始";
                nextLevelBtn.onclick = () => {
                    playSFX('click');
                    gsap.to(levelCompleteModal, {
                        opacity: 0, scale: 0.8, duration: 0.3, ease: "power1.in",
                        onComplete: () => {
                            levelCompleteModal.classList.remove('active');
                            levelCompleteModal.style.transform = ''; // Clear GSAP transform
                            currentProblemIndex = 0;
                            xp = 0;
                            level = 1;
                            achievements = {};
                            localStorage.removeItem('sumMultipleGameProgress');
                            loadProblem(); // This will recall loadProblem, updateUI, displayCrystals, etc.
                        }
                    });
                };
                if (!levelCompleteModal.classList.contains('active')) { // Only animate if not already active
                    levelCompleteModal.classList.add('active');
                    gsap.fromTo(levelCompleteModal, {opacity:0, scale:0.8}, {opacity:1, scale:1, duration:0.5, ease: "back.out(1.7)"});
                }
                animateGuideOrbToElement(nextLevelBtn);
                return;
            }

            currentProblem = problems[currentProblemIndex];
            updateUI(); // Update level display etc. based on currentProblemIndex and level
            problemStoryElement.textContent = currentProblem.story;
            multipleDisplayElement.textContent = currentProblem.multiple;
            largerPartsDisplayElement.textContent = currentProblem.multiple;
            
            displayCrystals(currentProblem);
            resetProblemState();
            spawnKnowledgeFragments();
        }
        
        function resetProblemState() {
            currentStep = 0;
            stepPanels.forEach((panel, index) => {
                panel.classList.toggle('hidden', index !== 0);
            });
            
            [totalPartsInputElement, onePartValueInputElement, smallerValueInputElement, largerValueInputElement].forEach(input => input.value = '');
            feedbackTextElement.textContent = '';
            feedbackTextElement.className = 'mt-3 font-semibold h-6';
            
            totalSumDisplayElement.textContent = currentProblem.sum;
            largerPartsFinalDisplayElement.textContent = currentProblem.multiple;

            if (!introModal.classList.contains('active') && !levelCompleteModal.classList.contains('active')) {
                 animateGuideOrbToElement(totalPartsInputElement);
            }
        }

        function handleAnswer(step, inputValue, correctValue, nextInput, successMessage, errorMessage) {
            const numericValue = parseFloat(inputValue);
            if (isNaN(numericValue) || numericValue !== correctValue) {
                feedbackTextElement.textContent = errorMessage || "答案不对哦，再想想！";
                feedbackTextElement.className = 'mt-3 font-semibold h-6 feedback-incorrect';
                gsap.fromTo(feedbackTextElement, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3});
                if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
                animateGuideOrbToElement(document.getElementById(stepPanels[currentStep].querySelector('input, button').id));
                gsap.to(`#${stepPanels[currentStep].id}`, {x: -5, duration: 0.05, repeat: 3, yoyo: true, clearProps: "x", onComplete: () => {
                    gsap.to(`#${stepPanels[currentStep].id}`, {x: 0});
                }});
                playSFX('incorrect');
                return false;
            }

            feedbackTextElement.textContent = successMessage || "正确！进入下一步。";
            feedbackTextElement.className = 'mt-3 font-semibold h-6 feedback-correct';
            gsap.fromTo(feedbackTextElement, {opacity:0, y:-10}, {opacity:1, y:0, duration:0.3});
            addXP(xpPerCorrectStep);
            
            if (step === 1) confirmedTotalPartsElement.textContent = correctValue;
            if (step === 2) confirmedOnePartValueElement.textContent = correctValue;
            if (step === 3) confirmedSmallerValueElement.textContent = correctValue;

            currentStep++;
            if (currentStep < stepPanels.length) {
                stepPanels.forEach((panel, index) => panel.classList.toggle('hidden', index !== currentStep));
                if (nextInput) {
                    // Ensure element is visible before focusing
                    setTimeout(() => nextInput.focus(), 0); 
                    animateGuideOrbToElement(nextInput);
                }
            } else {
                completeProblem();
            }
            playSFX('correct');
            return true;
        }

        function completeProblem() {
            feedbackTextElement.textContent = "太棒了！你解决了这个问题！";
            feedbackTextElement.className = 'mt-3 font-semibold h-6 feedback-correct';
            addXP(xpPerCorrectStep * 2); 
            
            levelCompleteTitle.textContent = `第 ${level} 关完成！`; // Level here is the one just completed
            levelCompleteMessage.textContent = `你成功找到了 ${currentProblem.smallerName} 和 ${currentProblem.largerName} 的能量！`;
            levelSummaryElement.innerHTML = `
                <p>${currentProblem.smallerName} (1份): ${currentProblem.solution.smallerValue}</p>
                <p>${currentProblem.largerName} (${currentProblem.multiple}份): ${currentProblem.solution.largerValue}</p>
                <p>总能量: ${currentProblem.sum}</p>
                <i class="fas fa-star text-yellow-400 text-3xl my-2"></i>
            `;
            nextLevelBtn.textContent = "下一关";
            nextLevelBtn.onclick = () => {
                playSFX('click');
                gsap.to(levelCompleteModal, {
                    opacity: 0, scale: 0.8, duration: 0.3, ease: "power1.in",
                    onComplete: () => {
                        levelCompleteModal.classList.remove('active');
                        levelCompleteModal.style.transform = ''; // Clear GSAP transform
                        
                        currentProblemIndex++;
                        level++; 
                        loadProblem(); // This will call updateUI with the new level
                    }
                });
            };
            
            if (!levelCompleteModal.classList.contains('active')) {
                levelCompleteModal.classList.add('active');
                gsap.fromTo(levelCompleteModal, {opacity:0, scale:0.8}, {opacity:1, scale:1, duration:0.5, ease: "back.out(1.7)"});
            }
            animateGuideOrbToElement(nextLevelBtn);
            playSFX('levelComplete');

            if (!achievements['firstSolve'] && currentProblemIndex === 0) { // Check currentProblemIndex before it's incremented for next level
                unlockAchievement('firstSolve', '初学乍练: 完成第一个和倍问题！');
            }
            if (!achievements['threeSolves'] && currentProblemIndex === 2) {
                 unlockAchievement('threeSolves', '渐入佳境: 完成三个和倍问题！');
            }
        }
        
        function addXP(amount) {
            xp += amount;
            updateXPBar();
            // checkLevelUp(); // Leveling is per problem in this version
            saveProgress();
        }

        function updateXPBar() {
            xpValueElement.textContent = xp;
            const progressPercentage = Math.min(100, (xp % xpToNextLevel) / xpToNextLevel * 100);
            xpBarElement.style.width = progressPercentage + '%';
            xpBarElement.textContent = Math.floor(progressPercentage) + '%';
        }
        
        function updateUI() {
            xpValueElement.textContent = xp;
            levelValueElement.textContent = level; // `level` should be updated before this if it changed
            updateXPBar();
        }

        function unlockAchievement(id, text) {
            if (achievements[id]) return;
            achievements[id] = true;
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-text').textContent = text;
            gsap.fromTo(toast, {y: -100, opacity: 0}, {y: 0, opacity: 1, duration: 0.5, ease: "back.out(1.7)", onComplete: () => {
                gsap.to(toast, {opacity: 0, y: -100, delay: 3, duration: 0.5, ease: "power1.in"});
            }});
            playSFX('achievement');
            saveProgress();
        }

        function playSFX(type) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (!audioCtx) return;

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);

            switch(type) {
                case 'correct':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
                    break;
                case 'incorrect':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.4);
                    break;
                case 'click':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.1);
                    break;
                case 'achievement':
                case 'levelComplete':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.5); 
                    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.7);
                    break;
            }
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 1);
        }
        
        function spawnKnowledgeFragments() {
            const container = document.getElementById('knowledge-fragments-container');
            container.innerHTML = '';
            const numFragments = Math.floor(Math.random() * 3) + 1;

            for (let i = 0; i < numFragments; i++) {
                const frag = document.createElement('div');
                frag.className = 'collectible-fragment';
                frag.style.left = `${Math.random() * 80 + 10}%`;
                frag.style.top = `${Math.random() * 40 + 10}%`;
                frag.innerHTML = `<i class="fas fa-lightbulb text-yellow-700"></i>`;
                frag.title = "知识碎片：点击获取和倍问题小提示！";

                const knowledge = [
                    "和倍问题中，'和'是总量，'倍'是关系。",
                    "关键是找到'1份'代表多少。",
                    "总份数 = 1份 + 倍数份。",
                    "1份的量 = 总和 ÷ 总份数。"
                ];
                const randomTip = knowledge[Math.floor(Math.random() * knowledge.length)];

                frag.onclick = () => {
                    playSFX('click');
                    addXP(5);
                    feedbackTextElement.textContent = `提示: ${randomTip}`;
                    feedbackTextElement.className = 'mt-3 font-semibold h-6 text-blue-300';
                    gsap.fromTo(feedbackTextElement, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3});
                    gsap.to(frag, {scale: 0, opacity: 0, duration: 0.3, onComplete: () => frag.remove()});
                    if (!achievements['foundFragment']) {
                        unlockAchievement('foundFragment', '探索家: 找到第一个知识碎片！');
                    }
                };
                container.appendChild(frag);
                gsap.from(frag, {scale: 0, opacity: 0, duration: 0.5, delay: i * 0.2, ease: "back.out(1.7)"});
            }
        }

        function setupEventListeners() {
            startGameBtn.addEventListener('click', () => {
                playSFX('click');
                gsap.to(introModal, {
                    opacity: 0, scale: 0.8, duration: 0.3, ease: "power1.in",
                    onComplete: () => {
                        introModal.classList.remove('active');
                        introModal.style.transform = ''; // Clear GSAP transform
                        animateGuideOrbToElement(totalPartsInputElement);
                    }
                });
            });

            submitTotalPartsButton.addEventListener('click', () => {
                playSFX('click');
                handleAnswer(1, totalPartsInputElement.value, currentProblem.solution.totalParts, onePartValueInputElement,
                    "总份数正确！现在计算1份的能量。",
                    "总份数不对哦。提示：乙是1份，甲是它的" + currentProblem.multiple + "倍。");
            });

            submitOnePartValueButton.addEventListener('click', () => {
                playSFX('click');
                handleAnswer(2, onePartValueInputElement.value, currentProblem.solution.onePartValue, smallerValueInputElement,
                    "每份能量计算正确！接下来是乙水晶堆的能量。",
                    "1份的能量计算有误。提示：总能量 ÷ 总份数 = ?");
            });

            submitSmallerValueButton.addEventListener('click', () => {
                playSFX('click');
                handleAnswer(3, smallerValueInputElement.value, currentProblem.solution.smallerValue, largerValueInputElement,
                    "乙水晶堆能量正确！最后是甲水晶堆的能量。",
                    "乙水晶堆的能量不对。提示：乙水晶堆就是1份的能量。");
            });
            
            submitLargerValueButton.addEventListener('click', () => {
                playSFX('click');
                handleAnswer(4, largerValueInputElement.value, currentProblem.solution.largerValue, null,
                    "太棒了！甲水晶堆能量也正确！",
                    "甲水晶堆的能量不对。提示：甲水晶堆的能量 = 1份的能量 × " + currentProblem.multiple + "。");
            });
            
            window.addEventListener('resize', onWindowResize, false);
            document.querySelectorAll('input[type="number"], button').forEach(el => {
                el.style.minHeight = '50px';
                if (el.tagName === 'INPUT') el.style.minWidth = '100px';
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            let activeElementForOrb = null;
            if (introModal.classList.contains('active')) {
                activeElementForOrb = startGameBtn;
            } else if (levelCompleteModal.classList.contains('active')) {
                activeElementForOrb = nextLevelBtn;
            } else if (stepPanels[currentStep] && !stepPanels[currentStep].classList.contains('hidden')) {
                activeElementForOrb = stepPanels[currentStep].querySelector('input, button');
            }
            if(activeElementForOrb) animateGuideOrbToElement(activeElementForOrb);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (smallerCrystalGroup && largerCrystalGroup) {
                const time = Date.now() * 0.001;
                smallerCrystalGroup.position.y = Math.sin(time * 2) * 0.1;
                largerCrystalGroup.position.y = Math.cos(time * 2 + 0.5) * 0.1;
            }
            renderer.render(scene, camera);
        }

        function saveProgress() {
            const progress = {
                xp,
                level,
                currentProblemIndex,
                achievements
            };
            localStorage.setItem('sumMultipleGameProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('sumMultipleGameProgress');
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                xp = progress.xp || 0;
                level = progress.level || 1;
                currentProblemIndex = progress.currentProblemIndex || 0;
                achievements = progress.achievements || {};
                if (currentProblemIndex > 0 || xp > 0 || Object.keys(achievements).length > 0) { // If any progress, hide intro
                     introModal.classList.remove('active');
                     introModal.style.opacity = '0'; 
                     introModal.style.pointerEvents = 'none';
                }
            }
        }
        
        initThree();

    </script>
</body>
</html>